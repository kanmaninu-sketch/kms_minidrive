<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Mini Google Drive</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background: #f8f9fa; }
    .container { max-width: 900px; }
    .file-meta { flex: 1; }
    .file-row { display:flex; gap:12px; align-items:center; width:100%; }
  </style>
</head>
<body class="bg-light">
  <div class="container py-5">
    <h2 class="mb-4 text-center">üìÅ Mini Google Drive</h2>

    <!-- Search and actions -->
    <div class="d-flex mb-3 gap-2">
      <input id="searchInput" class="form-control" placeholder="Search files by name..." type="search" />
      <button id="refreshBtn" class="btn btn-outline-secondary">Refresh</button>
      <a href="/upload-page" class="btn btn-primary">Upload</a>
    </div>

    <div id="status"></div>

    <!-- File list -->
    <ul id="fileList" class="list-group"></ul>
  </div>

  <script>
    const BACKEND = 'http://13.204.3.189:5000';

    function getToken() {
      return localStorage.getItem('token');
    }

    function setStatus(html) {
      document.getElementById('status').innerHTML = html;
    }

    async function fetchFiles() {
      const token = getToken();
      if (!token) {
        setStatus('<div class="alert alert-warning">Please log in first.</div>');
        return [];
      }
      try {
        const res = await fetch(`${BACKEND}/files`, {
          headers: { 'Authorization': 'Bearer ' + token }
        });
        const data = await res.json().catch(()=>({}));
        if (!res.ok) {
          setStatus('<div class="alert alert-danger">Error: ' + (data.error || res.statusText) + '</div>');
          return [];
        }
        return Array.isArray(data) ? data : (data.files || []);
      } catch (err) {
        setStatus('<div class="alert alert-danger">Network error: ' + err.message + '</div>');
        return [];
      }
    }

    function renderList(files) {
      const list = document.getElementById('fileList');
      list.innerHTML = '';
      if (!files || files.length === 0) {
        list.innerHTML = '<li class="list-group-item">No files found.</li>';
        return;
      }
      for (const f of files) {
        const filename = f.filename || f.name || '';
        const uploaded = f.uploaded || f.upload_date || '';
        const li = document.createElement('li');
        li.className = 'list-group-item';

        li.innerHTML = `
          <div class="file-row">
            <div class="file-meta">
              <strong>${escapeHtml(filename)}</strong>
              <div class="text-muted small">${escapeHtml(String(uploaded))}</div>
            </div>
            <div>
              <button class="btn btn-sm btn-success btn-download">Download</button>
              <button class="btn btn-sm btn-danger btn-delete">Delete</button>
              <button class="btn btn-sm btn-outline-secondary btn-share">Share</button>
            </div>
          </div>
        `;

        li.querySelector('.btn-download').addEventListener('click', ()=> downloadFile(filename));
        li.querySelector('.btn-delete').addEventListener('click', ()=> confirmDelete(filename));
        li.querySelector('.btn-share').addEventListener('click', ()=> shareFile(filename));

        list.appendChild(li);
      }
    }

    async function downloadFile(filename) {
      const token = getToken();
      if (!token) { setStatus('<div class="alert alert-warning">Login required.</div>'); return; }
      try {
        const res = await fetch(`${BACKEND}/download/${encodeURIComponent(filename)}`, {
          headers: { 'Authorization': 'Bearer ' + token }
        });
        const j = await res.json().catch(()=>({}));
        if (res.ok && j.url) window.open(j.url, '_blank');
        else setStatus('<div class="alert alert-danger">Download failed: ' + (j.error || res.statusText) + '</div>');
      } catch (err) {
        setStatus('<div class="alert alert-danger">Network error: ' + err.message + '</div>');
      }
    }

    async function confirmDelete(filename) {
      if (!confirm('Delete ' + filename + '?')) return;
      await deleteFile(filename);
      await refreshAndFilter();
    }

    async function deleteFile(filename) {
      const token = getToken();
      try {
        const res = await fetch(`${BACKEND}/delete/${encodeURIComponent(filename)}`, {
          method: 'DELETE',
          headers: { 'Authorization': 'Bearer ' + token }
        });
        const j = await res.json().catch(()=>({}));
        if (res.ok) setStatus('<div class="alert alert-success">' + (j.message || 'Deleted') + '</div>');
        else setStatus('<div class="alert alert-danger">Delete failed: ' + (j.error || res.statusText) + '</div>');
      } catch (err) {
        setStatus('<div class="alert alert-danger">Network error: ' + err.message + '</div>');
      }
    }

    async function shareFile(filename) {
      const token = getToken();
      try {
        const res = await fetch(`${BACKEND}/share/${encodeURIComponent(filename)}`, {
          method: 'POST',
          headers: { 'Authorization': 'Bearer ' + token }
        });
        const j = await res.json().catch(() => ({}));
        if (res.ok && j.share_url) {
          setStatus(`
            <div class="alert alert-info">
              ‚úÖ Share link generated:<br>
              <input type="text" id="shareLink" class="form-control mt-2" value="${j.share_url}" readonly>
              <button class="btn btn-sm btn-outline-primary mt-2" onclick="copyShareLink()">Copy Again</button>
            </div>
          `);
          if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard.writeText(j.share_url).catch(() => {});
          }
        } else {
          setStatus('<div class="alert alert-danger">Share failed: ' + (j.error || res.statusText) + '</div>');
        }
      } catch (err) {
        setStatus('<div class="alert alert-danger">Network error: ' + err.message + '</div>');
      }
    }

    function copyShareLink() {
      const link = document.getElementById("shareLink").value;
      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(link)
          .then(() => alert("‚úÖ Link copied again!"))
          .catch(() => alert("‚ö†Ô∏è Copy failed. Please copy manually."));
      } else {
        alert("‚ö†Ô∏è Clipboard not supported. Please copy manually.");
      }
    }

    function filterFiles(list, q) {
      if (!q) return list;
      const s = q.trim().toLowerCase();
      return list.filter(f => (f.filename || f.name || '').toLowerCase().includes(s));
    }

    async function refreshAndFilter() {
      setStatus('');
      const all = await fetchFiles();
      window._filesCache = all;
      const q = document.getElementById('searchInput').value;
      renderList(filterFiles(all, q));
    }

    document.getElementById('refreshBtn').addEventListener('click', refreshAndFilter);
    document.getElementById('searchInput').addEventListener('input', ()=> {
      const filtered = filterFiles(window._filesCache || [], document.getElementById('searchInput').value);
      renderList(filtered);
    });

    (async ()=> { await refreshAndFilter(); })();

    function escapeHtml(s) {
      return String(s || '').replace(/[&<>"']/g, (m) => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m]);
    }
  </script>
</body>
</html>

